{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "邮件告警",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 5,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 648,
          "layoutY": 151
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "to asset",
        "debugMode": true,
        "singletonMode": false,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "RELATED",
          "entityType": null,
          "entityNamePattern": null,
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 674,
          "layoutY": 302
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "get all info",
        "debugMode": true,
        "singletonMode": false,
        "configurationVersion": 1,
        "configuration": {
          "tellFailureIfAbsent": false,
          "fetchTo": "METADATA",
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "alarmsInfo",
            "deviceAttr"
          ],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 971,
          "layoutY": 259
        },
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "to email",
        "debugMode": true,
        "singletonMode": false,
        "configurationVersion": 0,
        "configuration": {
          "fromTemplate": "haonan@sharetek.com.cn",
          "toTemplate": "zhaojinxiu@sharetek.com.cn",
          "ccTemplate": "wangzhiqiang@sharetek.com.cn",
          "bccTemplate": "",
          "subjectTemplate": "邮件告警报告",
          "mailBodyType": "true",
          "bodyTemplate": "<style>\n      h3 {\n        text-align: center;\n    }\n\n    table {\n        width: 100%;\n        border-collapse: collapse;\n    }\n\n    tr {\n        border-bottom: 0.5px #ccc solid;\n    }\n\n    th {\n        text-align: left;\n        background: #455e83;\n        color: #fff;\n        padding: 6px;\n    }\n\n    td {\n        border-bottom: 1px solid #ccc;\n        line-height: 30px;\n        padding: 6px;\n    }\n</style>\n\n <h3>\n        EAP告警汇总\n    </h3>\n<table>\n  <thead>\n    <tr>\n      <th>机台ID</th>\n      <th>区域</th>\n      <th>所属模组</th>\n      <th>部署IP</th>\n      <th>状态</th>\n   <th>持续时长</th>\n    </tr>\n  </thead>\n  <tbody>\n    ${html}\n  </tbody>\n</table>\n\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1170,
          "layoutY": 461
        },
        "type": "org.thingsboard.rule.engine.mail.TbSendEmailNode",
        "name": "send",
        "debugMode": true,
        "singletonMode": false,
        "configurationVersion": 0,
        "configuration": {
          "useSystemSmtpSettings": true,
          "smtpHost": "localhost",
          "smtpPort": 25,
          "username": null,
          "password": null,
          "smtpProtocol": "smtp",
          "timeout": 10000,
          "enableTls": false,
          "tlsVersion": "TLSv1.2",
          "enableProxy": false,
          "proxyHost": null,
          "proxyPort": null,
          "proxyUser": null,
          "proxyPassword": null
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 609,
          "layoutY": 538
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "format",
        "debugMode": true,
        "singletonMode": false,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var tableDom = '';\nvar deviceAttr = metadata.ss_deviceAttr;\nvar alarmsInfo = metadata.ss_alarmsInfo;\nvar now_time = Date.now();\nif (deviceAttr != undefined && alarmsInfo != undefined) {\n    deviceAttr = JSON.parse(deviceAttr);\n    alarmsInfo = JSON.parse(alarmsInfo);\n    if (alarmsInfo.info && alarmsInfo.info.length > 0) {\n        for (var i = 0; i < alarmsInfo.info.length; i++) {\n            var deviceObj = deviceAttr[alarmsInfo.info[i]\n                .name]\n            var ts = +alarmsInfo.info[i].ts;\n            tableDom += '<tr>' +\n                '<td>' + alarmsInfo.info[i].name + '</td>' +\n                '<td>' + deviceObj.area + '</td>' +\n                '<td>' + deviceObj.belongTo + '</td>' +\n                '<td>' + deviceObj.ip + '</td>' +\n                '<td>' + alarmsInfo.info[i].state +  '</td>' +\n                '<td>' + ((now_time - ts)/60000).toFixed(2) + 'min' + '</td>' +\n                '</tr>';\n\n        }\n    }\n\n\n    metadata.html = tableDom;\n}\n\nmetadata.html = tableDom;\nreturn {\n    msg: msg,\n    metadata: metadata,\n    msgType: msgType\n    \n};",
          "tbelScript": "var htmlTable = '';\nvar deviceInfo = metadata.ss_deviceInfo;\nvar EAPConnectState = metadata.ss_EAPConnectState;\nif(deviceInfo != undefined){\n    deviceInfo = JSON.parse(deviceInfo);\n    EAPConnectState = JSON.parse(EAPConnectState);\n    \n    var deviceNames = Object.keys(deviceInfo);\n    for (var i = 0; i < deviceNames.length; i++) {\n        var device = deviceInfo[deviceNames[i]];\n        var eapState = EAPConnectState[deviceNames[i]];\n        htmlTable += '<tr>' +\n                        '<td>' + deviceNames[i] + '</td>' +\n                        '<td>' + device.ip + '</td>' +\n                        '<td>' + device.area + '</td>' +\n                        '<td>' + device.module + '</td>' +\n                        '<td>' + eapState.state + '</td>' +\n                     '</tr>';\n    }\n\n    metadata.html = htmlTable;\n}\n\nmetadata.html = htmlTable;\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 325,
          "layoutY": 137
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "save",
        "debugMode": false,
        "singletonMode": false,
        "configurationVersion": 0,
        "configuration": {
          "defaultTTL": 0,
          "skipLatestPersistence": false,
          "useServerTs": false
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 0,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}